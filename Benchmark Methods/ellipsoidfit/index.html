
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A novel method for the full three-axis magnetometer and three-axis Gyroscope bias estimation using angular rate measurements.">
      
      
        <meta name="author" content="Sebastián Rodríguez - CoMPAS Lab - Monterey Bay Aquarium Research Institute.">
      
      
      
        <link rel="prev" href="../../Proposed%20Methods/magyc_ifg/">
      
      
        <link rel="next" href="../magfactor3/">
      
      
      <link rel="icon" href="../../logo/compas_favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>Ellipsoid Fit - MAGYC: Magnetometer and Gyroscope Calibration</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ellipsoid-fit-implementation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MAGYC: Magnetometer and Gyroscope Calibration" class="md-header__button md-logo" aria-label="MAGYC: Magnetometer and Gyroscope Calibration" data-md-component="logo">
      
  <img src="../../logo/compas_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MAGYC: Magnetometer and Gyroscope Calibration
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ellipsoid Fit
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="light" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MAGYC: Magnetometer and Gyroscope Calibration" class="md-nav__button md-logo" aria-label="MAGYC: Magnetometer and Gyroscope Calibration" data-md-component="logo">
      
  <img src="../../logo/compas_logo.png" alt="logo">

    </a>
    MAGYC: Magnetometer and Gyroscope Calibration
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Proposed Methods
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Proposed Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_ls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-LS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_nls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-NLS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_bfg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-BFG
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_ifg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-IFG
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Benchmark Methods
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Benchmark Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Ellipsoid Fit
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Ellipsoid Fit
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#magnetic-calibration-method" class="md-nav__link">
    <span class="md-ellipsis">
      Magnetic Calibration method
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Magnetic Calibration method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soft-iron" class="md-nav__link">
    <span class="md-ellipsis">
      Soft-Iron
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hard-iron" class="md-nav__link">
    <span class="md-ellipsis">
      Hard-Iron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit" class="md-nav__link">
    <span class="md-ellipsis">
      ellipsoid_fit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit_fang" class="md-nav__link">
    <span class="md-ellipsis">
      ellipsoid_fit_fang
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../magfactor3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GTSAM magFactor3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../magcalgyro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magnetometer Calibration Gyro Aided
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spherefit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sphere Fit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../twostep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TWOSTEP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Synthetic Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Synthetic Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Synthetic%20Data/synthetic_data_generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Synthetic Data Generation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Plots
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Plots
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Plots/3d_magnetic_field_plot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3D Magnetic Field Plot
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utilities
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Utilities/hsi_calibration_validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HSI Calibration Validation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Utilities/pds_geodesic_distance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PDS Geodesic Distance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../License/license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulated_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulated Data
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#magnetic-calibration-method" class="md-nav__link">
    <span class="md-ellipsis">
      Magnetic Calibration method
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Magnetic Calibration method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#soft-iron" class="md-nav__link">
    <span class="md-ellipsis">
      Soft-Iron
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hard-iron" class="md-nav__link">
    <span class="md-ellipsis">
      Hard-Iron
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit" class="md-nav__link">
    <span class="md-ellipsis">
      ellipsoid_fit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit_fang" class="md-nav__link">
    <span class="md-ellipsis">
      ellipsoid_fit_fang
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="ellipsoid-fit-implementation">Ellipsoid Fit Implementation</h1>
<p>This script aims to implement the ellipsoid fit method proposed in [1] to develop a method for magnetic compass calibration. As the algebraic analysis presented in section (IV) of the paper is not enough for the direct implementation, we will take the algebraic analysis further for the straightforward Python implementation.</p>
<p>[1] Liu, Y. X., Li, X. S., Zhang, X. J., &amp; Feng, Y. B. (2014). Novel calibration algorithm for a three-axis strapdown magnetometer. Sensors, 14(5), 8485-8504.</p>
<h2 id="magnetic-calibration-method">Magnetic Calibration method</h2>
<p>The measurement of a magnetic compass can be modeled as:</p>
<div class="arithmatex">\[ h_m^b = Mh^b + b + n \]</div>
<p>Where <span class="arithmatex">\(b\)</span> is a constant offset that shifts the output of the sensors, and <span class="arithmatex">\(M\)</span> accounts for the the sensitivity of the individual axes of the sensor, the non-orthogonality and misalignment of the axes, and the sum of soft-iron errors fixed to the body frame, which serves to scale the sensor's output.</p>
<p>When the magnetic compass remains stationary and only changes direction, the magnitude of the true magnetic field <span class="arithmatex">\(||h^b||\)</span> remains constant, and the locus of the true magnetic field measured <span class="arithmatex">\(h^b\)</span> is a sphere. Meanwhile, the locus of the disturbed magnetic field measured <span class="arithmatex">\(h_m^b\)</span> is an ellipsoid, and it can be expressed as follows:</p>
<div class="arithmatex">\[ ||h^b||^2 = (h_m^b)^TAh_m^b - 2b^TAh_m^b + b^TAb + \tilde{n} \]</div>
<p>Where <span class="arithmatex">\(A = G^TG\)</span>, <span class="arithmatex">\(G = M^{-1}\)</span>, and <span class="arithmatex">\(\tilde{n} = 2(h_m^b-b)^TG^TGn + n^TG^TGn\)</span>. We can see that this is the expression of an ellipsoid in terms of <span class="arithmatex">\(h_m^b\)</span>. In other words, the measurements <span class="arithmatex">\((h_m^b)\)</span> with errors are constrained to lie on an ellipsoid. Thus, the calibration of the magnetic compass is to seek ellipsoid-fitting methods to solve the coefficients of <span class="arithmatex">\(G\)</span> and <span class="arithmatex">\(b\)</span>.</p>
<p>Since an ellipsoid is a kind of concoid, the ellipsoid equation can be expressed as a general equation of a concoid in the 3-D space as follows:</p>
<div class="arithmatex">\[ F(a, h_m^b) = a(h_{mx}^b)^2 + b(h_{mx}^bh_{my}^b) + c (h_{my}^b)^2 + d(h_{mx}^bh_{mz}^b) + e(h_{my}^bh_{mz}^b) + j(h_{mz}^b)^2 + p(h_{mx}^b) + q(h_{my}^b) + r(h_{mz}^b) + s = 0\]</div>
<p>Where <span class="arithmatex">\(a = \begin{bmatrix} a &amp;&amp; b &amp;&amp; c &amp;&amp; d &amp;&amp; e &amp;&amp; j &amp;&amp; p &amp;&amp; q &amp;&amp; r &amp;&amp; s\end{bmatrix}^T\)</span>. Moreover, the problem of fitting an ellipsoid into N data points <span class="arithmatex">\(h_m^b\)</span> can be solved by minimizing the sum of squares of the algebraic distance:</p>
<div class="arithmatex">\[ min \; \sum_{i}^nF_i(a, h_m^b)^2\]</div>
<p>We define the design matrix (we will use the notation <span class="arithmatex">\(h_j^i\)</span> to denote the i-th sample of <span class="arithmatex">\(h_{mj}^b\)</span>), where the i-th row is:</p>
<div class="arithmatex">\[ S_i = \begin{bmatrix} (h_{x}^i)^2 &amp;&amp; h_{x}^ih_{y}^i &amp;&amp; (h_{y}^i)^2 &amp;&amp; h_{x}^ih_{z}^i &amp;&amp; h_{y}^ih_{z}^i &amp;&amp; (h_{z}^i)^2 &amp;&amp; h_{x}^i &amp;&amp; h_{y}^i &amp;&amp; h_{z}^i &amp;&amp; 1 \end{bmatrix} \]</div>
<p>An additional property of the design matrix is that (S^TS) is symmetric:</p>
<div class="arithmatex">\[ (S^TS)^T = (S)^T(S^T)^T = S^TS \; \rightarrow \; (S^TS)^T = S^TS \]</div>
<p>Now, the minimization problem can be presented as:</p>
<div class="arithmatex">\[ min \; ||Sa||^2 \; \rightarrow \; min \; (Sa)^T(Sa) \; \rightarrow \; min \; a^TS^TSa\]</div>
<p>In order to avoid the trivial solution <span class="arithmatex">\(a = \mathbb{O}_{10}\)</span>, and recognizing that any multiple of a solution <span class="arithmatex">\(a\)</span> represents the same concoid, the parameter vector <span class="arithmatex">\(a\)</span> is constrained in someway. In order that the surface is fitted to be an ellipsoid in 3D, the parameters <span class="arithmatex">\(a\)</span> must insure the matrix <span class="arithmatex">\(A\)</span> to be either positive or negative definite, the equivalent constrained condition is:</p>
<div class="arithmatex">\[4ac - b^2 &gt; 0\]</div>
<p>The imposition of this inequality constraint is difficult in general; in this case, we have the freedom to arbitrarily scale the parameters, so we may simply incorporate the scaling into the constraint and impose the equality constraint <span class="arithmatex">\(<span class="arithmatex">\(4ac - b^2 = 1\)</span>\)</span>, which can be expressed in the matrix form of <span class="arithmatex">\(a^TCa = 1\)</span>, as:</p>
<div class="arithmatex">\[ C = \begin{bmatrix} C_1 &amp;&amp; C_2 \\ C_3 &amp;&amp; C_4 \end{bmatrix},\; \text{where:} \; C_1 = \begin{bmatrix} 0 &amp;&amp; 0 &amp;&amp; 2 \\ 0 &amp;&amp; -1 &amp;&amp; 0 \\ 2 &amp;&amp; 0 &amp;&amp; 0 \end{bmatrix}, \; C_2 = \mathbb{O}_{3 \times 7}, \; C_3 = \mathbb{O}_{7 \times 3}, \; C_4 = \mathbb{O}_{7 \times 7}\]</div>
<p>Notice that as <span class="arithmatex">\(C\)</span> is a block matrix, <span class="arithmatex">\(C_1 = C_1^T\)</span>, and all the other blocks are zeros:</p>
<div class="arithmatex">\[ C^T = \begin{bmatrix} C_1^T &amp;&amp; C_3^T \\ C_2^T &amp;&amp; C_4^T \end{bmatrix} \; \rightarrow \; C^T = \begin{bmatrix} C_1 &amp;&amp; C_2 \\ C_3 &amp;&amp; C_4 \end{bmatrix} = C\]</div>
<p>With this additional constraint, the optimization problem is:</p>
<div class="arithmatex">\[ min \; a^TS^TSa \quad s.t. \quad a^TCa - 1= 0\]</div>
<p>Using the Lagrange method:</p>
<div class="arithmatex">\[ \mathcal{L}(a) = a^TS^TSa - \lambda(a^TCa - 1= 0) \]</div>
<p>Differentiating with respect to <span class="arithmatex">\(a\)</span> we find:</p>
<div class="arithmatex">\[ \frac{\partial \mathcal{L}}{\partial a} = 0 \; \rightarrow \; a^T(S^TS + SS^T) - \lambda(a^T(C + C^T)) = 0 \; \rightarrow \; 2a^TS^TS - 2\lambda a^TC = 0 \; \rightarrow \; S^TSa = \lambda Ca\]</div>
<p>To solve this system, we can rewrite the matrix <span class="arithmatex">\(S^TS\)</span> as a block matrix:</p>
<div class="arithmatex">\[ S^TS = \begin{bmatrix} X_{11} &amp;&amp; X_{12} \\ X_{21} &amp;&amp; X_{22} \end{bmatrix}, \text{ where: } X_{11} \text{ is } 3 \times 3, \; X_{12} \text{ is } 3 \times 7, \; X_{21} \text{ is } 7 \times 3, \; X_{22} \text{ is } 7 \times 7\]</div>
<p>Furthermore, Using the definition that <span class="arithmatex">\(S^TS\)</span> is symmetric, then: <span class="arithmatex">\(X_{21} = X_{12}^T\)</span>:</p>
<div class="arithmatex">\[ S^TS = \begin{bmatrix} X_{11} &amp;&amp; X_{12} \\ X_{12}^T &amp;&amp; X_{22} \end{bmatrix}\]</div>
<p>We can also define: <span class="arithmatex">\(a_1 = \begin{bmatrix} a &amp;&amp; b &amp;&amp; c\end{bmatrix}^T\)</span> and <span class="arithmatex">\(a_2 = \begin{bmatrix} d &amp;&amp; e &amp;&amp; j &amp;&amp; p &amp;&amp; q &amp;&amp; r &amp;&amp; s\end{bmatrix}^T\)</span>, such that: <span class="arithmatex">\(a = \begin{bmatrix} a_1 &amp;&amp; a_2\end{bmatrix}^T\)</span>. Now, we can rewrite the system as:</p>
<div class="arithmatex">\[ \begin{bmatrix} X_{11} &amp;&amp; X_{12} \\ X_{12}^T &amp;&amp; X_{22} \end{bmatrix}\begin{bmatrix} a_1 \\ a_2\end{bmatrix} = \lambda \begin{bmatrix} C_1 &amp;&amp; C_2 \\ C_3 &amp;&amp; C_4 \end{bmatrix}\begin{bmatrix} a_1 \\ a_2\end{bmatrix} \]</div>
<p>Considering that <span class="arithmatex">\(C_2, C_3, C_4\)</span> are zero matrices, the first equation that we can get from this is:</p>
<div class="arithmatex">\[ X_{11}a_1 + X_{12}a_2 = \lambda C_1a_1 \]</div>
<p>The second equation is:</p>
<div class="arithmatex">\[ X_{12}^Ta_1 + X_{22}a_2 = 0 \]</div>
<p>If the data is not coplanar, the <span class="arithmatex">\(X_{22}\)</span> will be non-singular:</p>
<div class="arithmatex">\[ \rightarrow a_2 = -X_{22}^{-1}X_{12}^Ta_1 \]</div>
<p>Replacing this term in the first equation, and considering that <span class="arithmatex">\(C_1\)</span> is non-singular as <span class="arithmatex">\(det(C_1) = 4\)</span>:</p>
<div class="arithmatex">\[(X_{11} - \lambda C_1)a_1 + X_{12}(-X_{22}^{-1}X_{12}^Ta_1) = 0 \; \rightarrow \; C_1^{-1}(X_{11} - X_{12}X_{22}^{-1}X_{12}^T)a_1 = \lambda a_1 \]</div>
<p>It is proven that <strong>exactly one eigenvalue</strong> of the last system is positive. Let <span class="arithmatex">\(u_1\)</span> be the eigenvector associated with the only positive eigenvalue of the general system, then we can get the full solution: <span class="arithmatex">\(u = \begin{bmatrix} u_1 &amp;&amp; u_2\end{bmatrix}^T\)</span>. In the case that the matrix <span class="arithmatex">\((X_{11} - X_{12}X_{22}^{-1}X_{12}^T)\)</span> is singular, the corresponding <span class="arithmatex">\(u_1\)</span> can be replaced with the eigenvector associated with the largest eigenvalue.</p>
<p>With the previously defined equations, we are able to determine the values of: <span class="arithmatex">\(a = \begin{bmatrix} a &amp;&amp; b &amp;&amp; c &amp;&amp; d &amp;&amp; e &amp;&amp; j &amp;&amp; p &amp;&amp; q &amp;&amp; r &amp;&amp; s\end{bmatrix}^T\)</span>, and with those values we need to recover the soft-iron and hard-iron, <span class="arithmatex">\(M\)</span> and <span class="arithmatex">\(b\)</span>, respectively. By definition:</p>
<h3 id="soft-iron">Soft-Iron</h3>
<div class="arithmatex">\[ A = \begin{bmatrix} a &amp;&amp; b/2 &amp;&amp; d/2 \\ b/2 &amp;&amp; c &amp;&amp; e/2 \\ d/2 &amp;&amp; e/2 &amp;&amp; j \end{bmatrix} \]</div>
<p>And we also defined that: <span class="arithmatex">\(G^TG = A\)</span>, with <span class="arithmatex">\(G = M^{-1}\)</span>. However, there are uncountable matrices <span class="arithmatex">\(G\)</span> which can satisfy <span class="arithmatex">\(G^TG = A\)</span>. Thus, we select the x-axis of the sensors as the x-axis of the magnetic compass; thus we can obtain the unique <span class="arithmatex">\(G\)</span> by singular value decomposition.</p>
<div class="arithmatex">\[ G = U_G\Sigma_G V_G^T \; \rightarrow G^TG = (V_G\Sigma_G^TU_G^T)(U_G\Sigma_G V_G^T) \; \leftrightarrow \; G^TG = V_G\Sigma_G^T\Sigma_G V_G^T \]</div>
<p>As A is a symmetric matrix, then: <span class="arithmatex">\(A^T = A \; \rightarrow \; G^TG = GG^T\)</span>.</p>
<div class="arithmatex">\[ G = U_G\Sigma_G V_G^T \; \rightarrow GG^T = (U_G\Sigma_G V_G^T)(V_G\Sigma_G^T U_G^T) \; \leftrightarrow \; GG^T = U_G\Sigma_G \Sigma_G^T U_G^T \]</div>
<p>If we do the singular value decomposition of A:</p>
<div class="arithmatex">\[ V_G\Sigma_G^T\Sigma_G V_G^T = U_A \Sigma_A V_A^T \qquad \qquad U_G\Sigma_G\Sigma_G^T U_G^T = U_A \Sigma_A V_A^T \]</div>
<p>Then, as <span class="arithmatex">\(A\)</span> is a symmetric matrix, then: <span class="arithmatex">\(U = V\)</span>, therefore:</p>
<div class="arithmatex">\[ U_G = U_A \qquad \qquad V_G = V_A \qquad \qquad \Sigma_G = \Sigma_A^{1/2} \]</div>
<p>Then:</p>
<div class="arithmatex">\[ G = U_G \Sigma_G V_G^T \quad \rightarrow \quad G = U_A \Sigma_A^{1/2} V_A^T \quad \rightarrow \quad M = (U_A \Sigma_A^{1/2} V_A^T)^{-1} \]</div>
<h3 id="hard-iron">Hard-Iron</h3>
<p>From the magnetic field magnitude we found that:</p>
<div class="arithmatex">\[ ||h^b||^2 = (h_m^b)^TAh_m^b - 2b^TAh_m^b + b^TAb + \tilde{n} \]</div>
<p>The first term of that equation is related to the quadratic terms, while the second term is related to the linear terms:</p>
<div class="arithmatex">\[ - 2b^TAh_m^b = \begin{matrix}h_{mx} \left(- 2 a b_{x} - b b_{y} - b_{z} e\right) + h_{my} \left(- b b_{x} - 2 b_{y} c - b_{z} d\right) + h_{mz} \left(- b_{x} e - b_{y} d - 2 b_{z} j\right)\end{matrix} \]</div>
<p>From the general equation of a concoid in the 3-D space, the linear terms are:</p>
<div class="arithmatex">\[ p(h_{mx}^b) + q(h_{my}^b) + r(h_{mz}^b) \]</div>
<p>Therefore, we have the system:</p>
<div class="arithmatex">\[ \begin{bmatrix} 2a &amp;&amp; b &amp;&amp; d \\ b &amp;&amp; 2c &amp;&amp; e \\ d &amp;&amp; e &amp;&amp; 2j \end{bmatrix} \begin{bmatrix} b_x \\ b_y \\ b_z \end{bmatrix} = \begin{bmatrix} p \\ q \\ r \end{bmatrix} \; \rightarrow \;  \begin{bmatrix} b_x \\ b_y \\ b_z \end{bmatrix} = \begin{bmatrix} 2a &amp;&amp; b &amp;&amp; d \\ b &amp;&amp; 2c &amp;&amp; e \\ d &amp;&amp; e &amp;&amp; 2j \end{bmatrix} ^{-1} \begin{bmatrix} p \\ q \\ r \end{bmatrix} \; \leftrightarrow \;  \begin{bmatrix} b_x \\ b_y \\ b_z \end{bmatrix} = (2A)^{-1} \begin{bmatrix} p \\ q \\ r \end{bmatrix}\]</div>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">

        <p>MAGYC - Benchmark Methods - Ellipsoid Fit</p>
<p>This module contains ellipsoid fit appraches for magnetometer calibration.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit" href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit">ellipsoid_fit</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Standard ellipsoid fit method.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit_fang" href="#magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit_fang">ellipsoid_fit_fang</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Ellipsoid fit method by Fang et al.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>
        



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ellipsoid_fit</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>The ellipsoid fit method is based on the fact that the error model of a magnetic
compass is an ellipsoid, and a constraint least-squares method is adopted to
estimate the parameters of an ellipsoid by rotating the magnetic compass in
various random orientations.</p>
<p>For further details about the implementation, refer to Aleksandr Bazhin <a href="https://github.com/aleksandrbazhin/ellipsoid_fit_python">Github
repository</a>, where he
ports to python [matlab's ellipsoid fit].(http://www.mathworks.com/matlabcentral/fileexchange/24693-ellipsoid-fit)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>magnetic_field</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Magnetic field measurements in a
3xN or Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hard_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hard iron bias.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>soft_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Soft iron matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated magnetic field measurements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is not a numpy array or a list.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is not a 3xN or Nx3 numpy array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>magyc/benchmark_methods/ellipsoidfit.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ellipsoid_fit</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ellipsoid fit method is based on the fact that the error model of a magnetic</span>
<span class="sd">    compass is an ellipsoid, and a constraint least-squares method is adopted to</span>
<span class="sd">    estimate the parameters of an ellipsoid by rotating the magnetic compass in</span>
<span class="sd">    various random orientations.</span>

<span class="sd">    For further details about the implementation, refer to Aleksandr Bazhin [Github</span>
<span class="sd">    repository](https://github.com/aleksandrbazhin/ellipsoid_fit_python), where he</span>
<span class="sd">    ports to python [matlab&#39;s ellipsoid fit].(http://www.mathworks.com/matlabcentral/fileexchange/24693-ellipsoid-fit)</span>

<span class="sd">    Args:</span>
<span class="sd">        magnetic_field (numpy.ndarray or list): Magnetic field measurements in a</span>
<span class="sd">            3xN or Nx3 numpy array or list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        hard_iron (numpy.ndarray): Hard iron bias.</span>
<span class="sd">        soft_iron (numpy.ndarray): Soft iron matrix.</span>
<span class="sd">        calibrated_magnetic_field (numpy.ndarray): Calibrated magnetic field measurements.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the input is not a numpy array or a list.</span>
<span class="sd">        ValueError: If the input is not a 3xN or Nx3 numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the input is a list and convert it to a numpy array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>

    <span class="c1"># Check if the input is a numpy array</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input must be a numpy array or a list.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the input is a 3xN or Nx3 numpy array</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Force the array to be a Nx3 numpy array</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Compute magnetic field calibration</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">d_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span>
            <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">d_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">d_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">a_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">9</span><span class="p">]]]</span>
    <span class="p">)</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">-</span><span class="n">a_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>

    <span class="n">translation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">translation_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">T</span>

    <span class="n">r_matrix</span> <span class="o">=</span> <span class="n">translation_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">translation_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">r_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="o">-</span><span class="n">r_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">evecs</span> <span class="o">=</span> <span class="n">evecs</span><span class="o">.</span><span class="n">T</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">evals</span><span class="p">))</span>
    <span class="n">radii</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">radii</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">r</span><span class="o">/</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">r</span><span class="o">/</span><span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">r</span><span class="o">/</span><span class="n">c</span><span class="p">]])</span>
    <span class="n">transformation</span> <span class="o">=</span> <span class="n">evecs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evecs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">hard_iron</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">soft_iron</span> <span class="o">=</span> <span class="n">transformation</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Calibrate magnetic field</span>
    <span class="n">calibrated_magnetic_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">soft_iron</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">soft_iron</span><span class="p">,</span> <span class="n">calibrated_magnetic_field</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="magyc.benchmark_methods.ellipsoidfit.ellipsoid_fit_fang" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ellipsoid_fit_fang</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>The ellipsoid fit method is based on the fact that the error model of a magnetic
compass is an ellipsoid, and a constraint least-squares method is adopted to
estimate the parameters of an ellipsoid by rotating the magnetic compass in
various random orientations.</p>
<p>For further details about the implementation, refer to section (III) in J. Fang,
H. Sun, J. Cao, X. Zhang, and Y. Tao, “A novel calibration method of magnetic
compass based on ellipsoid fitting,” IEEE Transactions on Instrumentation
and Measurement, vol. 60, no. 6, pp. 2053--2061, 2011.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>magnetic_field</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Magnetic field measurements in a
3xN or Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hard_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hard iron bias.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>soft_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Soft iron matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated magnetic field measurements.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is not a numpy array or a list.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is not a 3xN or Nx3 numpy array.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>RuntimeWarning</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no positive eigenvalues are found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>magyc/benchmark_methods/ellipsoidfit.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ellipsoid_fit_fang</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ellipsoid fit method is based on the fact that the error model of a magnetic</span>
<span class="sd">    compass is an ellipsoid, and a constraint least-squares method is adopted to</span>
<span class="sd">    estimate the parameters of an ellipsoid by rotating the magnetic compass in</span>
<span class="sd">    various random orientations.</span>

<span class="sd">    For further details about the implementation, refer to section (III) in J. Fang,</span>
<span class="sd">    H. Sun, J. Cao, X. Zhang, and Y. Tao, “A novel calibration method of magnetic</span>
<span class="sd">    compass based on ellipsoid fitting,” IEEE Transactions on Instrumentation</span>
<span class="sd">    and Measurement, vol. 60, no. 6, pp. 2053--2061, 2011.</span>

<span class="sd">    Args:</span>
<span class="sd">        magnetic_field (numpy.ndarray or list): Magnetic field measurements in a</span>
<span class="sd">            3xN or Nx3 numpy array or list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        hard_iron (numpy.ndarray): Hard iron bias.</span>
<span class="sd">        soft_iron (numpy.ndarray): Soft iron matrix.</span>
<span class="sd">        calibrated_magnetic_field (numpy.ndarray): Calibrated magnetic field measurements.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the input is not a numpy array or a list.</span>
<span class="sd">        ValueError: If the input is not a 3xN or Nx3 numpy array.</span>
<span class="sd">        RuntimeWarning: If no positive eigenvalues are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the input is a list and convert it to a numpy array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>

    <span class="c1"># Check if the input is a numpy array</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The input must be a numpy array or a list.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the input is a 3xN or Nx3 numpy array</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Force the array to be a Nx3 numpy array</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Compute magnetic field calibration</span>
    <span class="c1"># Design matrix (S)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
            <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
            <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]]),</span>
            <span class="n">magnetic_field</span><span class="p">[:,</span> <span class="p">:],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Block Matrices: S_11, S_12, S_22</span>
    <span class="n">sTs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">s</span>
    <span class="n">s_11</span><span class="p">,</span> <span class="n">s_12</span><span class="p">,</span> <span class="n">s_22</span> <span class="o">=</span> <span class="n">sTs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">sTs</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:],</span> <span class="n">sTs</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span> <span class="mi">3</span><span class="p">:]</span>

    <span class="c1"># Constrain matrix C_11</span>
    <span class="n">c_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

    <span class="c1"># Ellipsoid Parameters Estimation</span>
    <span class="n">eigenvals</span><span class="p">,</span> <span class="n">eigenvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">c_11</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">s_11</span> <span class="o">-</span> <span class="n">s_12</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">s_22</span><span class="p">)</span> <span class="o">@</span> <span class="n">s_12</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No positive eigenvalues: max eigenvalue = </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

    <span class="n">a_1</span> <span class="o">=</span> <span class="o">-</span><span class="n">eigenvecs</span><span class="p">[:,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)]]</span>
    <span class="n">a_2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">s_22</span><span class="p">)</span> <span class="o">@</span> <span class="n">s_12</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">a_1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">a_1</span><span class="p">,</span> <span class="n">a_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Determine A and b</span>
    <span class="n">a_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]]])</span>
    <span class="n">hard_iron</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a_matrix</span><span class="p">)</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>

    <span class="c1"># Determine G and M</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">a_matrix</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">u</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">@</span> <span class="n">vh</span>
    <span class="n">soft_iron</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="c1"># Calibrate magnetic field</span>
    <span class="n">calibrated_magnetic_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">soft_iron</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">soft_iron</span><span class="p">,</span> <span class="n">calibrated_magnetic_field</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>