
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A novel method for the full three-axis magnetometer and three-axis Gyroscope bias estimation using angular rate measurements.">
      
      
        <meta name="author" content="Sebastián Rodríguez - CoMPAS Lab - Monterey Bay Aquarium Research Institute.">
      
      
      
        <link rel="prev" href="../magfactor3/">
      
      
        <link rel="next" href="../spherefit/">
      
      
      <link rel="icon" href="../../logo/compas_favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>Magnetometer Calibration Gyro Aided - MAGYC: Magnetometer and Gyroscope Calibration</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MAGYC: Magnetometer and Gyroscope Calibration" class="md-header__button md-logo" aria-label="MAGYC: Magnetometer and Gyroscope Calibration" data-md-component="logo">
      
  <img src="../../logo/compas_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MAGYC: Magnetometer and Gyroscope Calibration
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Magnetometer Calibration Gyro Aided
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="light" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MAGYC: Magnetometer and Gyroscope Calibration" class="md-nav__button md-logo" aria-label="MAGYC: Magnetometer and Gyroscope Calibration" data-md-component="logo">
      
  <img src="../../logo/compas_logo.png" alt="logo">

    </a>
    MAGYC: Magnetometer and Gyroscope Calibration
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Proposed Methods
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Proposed Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_ls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-LS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_nls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-NLS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_bfg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-BFG
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Proposed%20Methods/magyc_ifg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAGYC-IFG
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Benchmark Methods
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Benchmark Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ellipsoidfit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ellipsoid Fit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../magfactor3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GTSAM magFactor3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Magnetometer Calibration Gyro Aided
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spherefit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sphere Fit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../twostep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TWOSTEP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Synthetic Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Synthetic Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Synthetic%20Data/synthetic_data_generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Synthetic Data Generation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Plots
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Plots
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Plots/3d_magnetic_field_plot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3D Magnetic Field Plot
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utilities
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Utilities/hsi_calibration_validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HSI Calibration Validation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Utilities/pds_geodesic_distance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PDS Geodesic Distance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../License/license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulated_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulated Data
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Magnetometer Calibration Gyro Aided</h1>

<div class="doc doc-object doc-function">




    <div class="doc doc-contents first">

        <p>The linear least squares for sensor bias calibration is seeks to minimize the
sum of squared residuals</p>
<div class="arithmatex">\[\sum_{i=1}^{n} \frac{1}{\sigma_i^2} ||\dot{x}_i + \omega_i \times (x_i - b)||^2\]</div>
<p>Where <span class="arithmatex">\(x(t)\)</span> is the measured magnetic field, <span class="arithmatex">\(\dot{x(t)}\)</span> is the measured
magnetic field differentiated with respect to time, <span class="arithmatex">\(\omega(t)\)</span> is the
measured angular-rate in instrument coordinates, <span class="arithmatex">\(b\)</span> is the hard-iron, and
<span class="arithmatex">\(\times\)</span> is the standard cross product operator.</p>
<p>This optimization problem can be solved in an analytical way. For further
information refer to section IV.A in Troni, G. and Whitcomb, L. L. (2019).
Field sensor bias calibration with angular-rate sensors: Theory and experimental
evaluation with application to magnetometer calibration. IEEE/ASME Transactions
on Mechatronics, 24(4):1698--1710.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>magnetic_field</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Magnetic field measurements in a
3xN or Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>angular_rate</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Angular rate measurements in a 3xN or
Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>time</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time measurements in a 1D numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hard_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hard iron bias.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated magnetic field measurements</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not numpy arrays or lists.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, and time do not have the same number of samples.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>magyc/benchmark_methods/sar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sar_ls</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">angular_rate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
           <span class="n">time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The linear least squares for sensor bias calibration is seeks to minimize the</span>
<span class="sd">    sum of squared residuals</span>

<span class="sd">    $$\\sum_{i=1}^{n} \\frac{1}{\\sigma_i^2} ||\\dot{x}_i + \\omega_i \\times (x_i - b)||^2$$</span>

<span class="sd">    Where $x(t)$ is the measured magnetic field, $\\dot{x(t)}$ is the measured</span>
<span class="sd">    magnetic field differentiated with respect to time, $\\omega(t)$ is the</span>
<span class="sd">    measured angular-rate in instrument coordinates, $b$ is the hard-iron, and</span>
<span class="sd">    $\\times$ is the standard cross product operator.</span>

<span class="sd">    This optimization problem can be solved in an analytical way. For further</span>
<span class="sd">    information refer to section IV.A in Troni, G. and Whitcomb, L. L. (2019).</span>
<span class="sd">    Field sensor bias calibration with angular-rate sensors: Theory and experimental</span>
<span class="sd">    evaluation with application to magnetometer calibration. IEEE/ASME Transactions</span>
<span class="sd">    on Mechatronics, 24(4):1698--1710.</span>

<span class="sd">    Args:</span>
<span class="sd">        magnetic_field (numpy.ndarray or list): Magnetic field measurements in a</span>
<span class="sd">            3xN or Nx3 numpy array or list.</span>
<span class="sd">        angular_rate (numpy.ndarray or list): Angular rate measurements in a 3xN or</span>
<span class="sd">            Nx3 numpy array or list.</span>
<span class="sd">        time (numpy.ndarray or list): Time measurements in a 1D numpy array or list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        hard_iron (numpy.ndarray): Hard iron bias.</span>
<span class="sd">        calibrated_magnetic_field (numpy.ndarray): Calibrated magnetic field measurements</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the magnetic field, angular rate, or time are not numpy arrays or lists.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, and time do not have the same number of samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the magnetic_field, angular_rate, and time are lists and convert them to numpy arrays</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time are numpy arrays</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The time must be a numpy array or a list.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field and angular_rate are 3xN or Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the time is a 1D numpy array</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The time must be a (n, ), (n, 1) or (1, n) numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Force the magnetic_field and angular_rate to be Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time have the same number of samples</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field, angular rate, and time must have the same number of samples.&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the magnetic calibration</span>
    <span class="c1"># Get the data variance</span>
    <span class="n">magnetic_field_variance</span> <span class="o">=</span> <span class="n">_get_sigma_noise</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>
    <span class="n">sigma_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">magnetic_field_variance</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute the skew-symmetric matrix of the angular rate.</span>
    <span class="n">skew_symmetric_angular_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">nm</span><span class="o">.</span><span class="n">vec_to_so3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">angular_rate</span><span class="p">)</span>

    <span class="c1"># Compute the magnetic field derivative</span>
    <span class="n">magnetic_field_derivative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">magnetic_field_derivative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">magnetic_field_derivative</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Estimate b</span>
    <span class="n">b1_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk-&gt;jk&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">skew_symmetric_angular_rate</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sigma_i</span><span class="p">)))</span>

    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
        <span class="s2">&quot;ijk-&gt;ikj&quot;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">angular_rate</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">magnetic_field_derivative</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk-&gt;jk&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">skew_symmetric_angular_rate</span> <span class="o">@</span> <span class="n">yi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sigma_i</span><span class="p">))</span>

    <span class="n">hard_iron</span> <span class="o">=</span> <span class="n">b1_inv</span> <span class="o">@</span> <span class="n">b2</span>

    <span class="c1"># Calibrate magnetic field</span>
    <span class="n">calibrated_magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span> <span class="o">-</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">calibrated_magnetic_field</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">




    <div class="doc doc-contents first">

        <p>The Kalman filter for sensor bias calibration uses the system model with  a
discretization of the continuous-time system the sensor bias estimation can
be solved with a standard discrete-time Kalman filter implementation that
does not require differentiation.</p>
<div class="arithmatex">\[\dot{x}_i = -\omega_i \times (x_i - b)\]</div>
<p>Where <span class="arithmatex">\(x(t)\)</span> is the measured magnetic field, <span class="arithmatex">\(\dot{x(t)}\)</span> is the measured
magnetic field differentiated with respect to time, <span class="arithmatex">\(\omega(t)\)</span> is the
measured angular-rate in instrument coordinates, and <span class="arithmatex">\(b\)</span> is the hard-iron.</p>
<p>For further information refer to section IV.B in Troni, G. and Whitcomb, L. L.
(2019). Field sensor bias calibration with angular-rate sensors: Theory and
experimental evaluation with application to magnetometer calibration. IEEE/ASME
Transactions on Mechatronics, 24(4):1698--1710.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>magnetic_field</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Magnetic field measurements in a
3xN or Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>angular_rate</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Angular rate measurements in a 3xN or
Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>time</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time measurements in a 1D numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gains</code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kalman filter gains.</p>
              </div>
            </td>
            <td>
                  <code>(1.0, 1.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>f_normalize</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the k2 gain should be scaled by and adaptive
constant computed as the reciprocal of the norm of the gyroscope measurement
for that step, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hard_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hard iron bias.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated magnetic field measurements</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_filteres_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated and filtered magnetic field measurements</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not numpy arrays or lists.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, and time do not have the same number of samples.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the gains are not a tuple of floats.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the f_normalize is not a boolean.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>magyc/benchmark_methods/sar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sar_kf</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">angular_rate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
           <span class="n">time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">gains</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
           <span class="n">f_normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Kalman filter for sensor bias calibration uses the system model with  a</span>
<span class="sd">    discretization of the continuous-time system the sensor bias estimation can</span>
<span class="sd">    be solved with a standard discrete-time Kalman filter implementation that</span>
<span class="sd">    does not require differentiation.</span>

<span class="sd">    $$\\dot{x}_i = -\\omega_i \\times (x_i - b)$$</span>

<span class="sd">    Where $x(t)$ is the measured magnetic field, $\\dot{x(t)}$ is the measured</span>
<span class="sd">    magnetic field differentiated with respect to time, $\\omega(t)$ is the</span>
<span class="sd">    measured angular-rate in instrument coordinates, and $b$ is the hard-iron.</span>

<span class="sd">    For further information refer to section IV.B in Troni, G. and Whitcomb, L. L.</span>
<span class="sd">    (2019). Field sensor bias calibration with angular-rate sensors: Theory and</span>
<span class="sd">    experimental evaluation with application to magnetometer calibration. IEEE/ASME</span>
<span class="sd">    Transactions on Mechatronics, 24(4):1698--1710.</span>

<span class="sd">    Args:</span>
<span class="sd">        magnetic_field (numpy.ndarray or list): Magnetic field measurements in a</span>
<span class="sd">            3xN or Nx3 numpy array or list.</span>
<span class="sd">        angular_rate (numpy.ndarray or list): Angular rate measurements in a 3xN or</span>
<span class="sd">            Nx3 numpy array or list.</span>
<span class="sd">        time (numpy.ndarray or list): Time measurements in a 1D numpy array or list.</span>
<span class="sd">        gains (tuple): Kalman filter gains.</span>
<span class="sd">        f_normalize (bool): Whether the k2 gain should be scaled by and adaptive</span>
<span class="sd">            constant computed as the reciprocal of the norm of the gyroscope measurement</span>
<span class="sd">            for that step, by default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        hard_iron (numpy.ndarray): Hard iron bias.</span>
<span class="sd">        calibrated_magnetic_field (numpy.ndarray): Calibrated magnetic field measurements</span>
<span class="sd">        calibrated_filteres_magnetic_field (numpy.ndarray): Calibrated and filtered magnetic field measurements</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the magnetic field, angular rate, or time are not numpy arrays or lists.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, and time do not have the same number of samples.</span>
<span class="sd">        TypeError: If the gains are not a tuple of floats.</span>
<span class="sd">        TypeError: If the f_normalize is not a boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the magnetic_field, angular_rate, and time are lists and convert them to numpy arrays</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time are numpy arrays</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The time must be a numpy array or a list.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field and angular_rate are 3xN or Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the time is a 1D numpy array</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The time must be a (n, ), (n, 1) or (1, n) numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Force the magnetic_field and angular_rate to be Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time have the same number of samples</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field, angular rate, and time must have the same number of samples.&quot;</span><span class="p">)</span>

    <span class="c1"># Check that the gains are a tuple of floats</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The gains must be a tuple of floats.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">gain</span> <span class="ow">in</span> <span class="n">gains</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The gains must be a tuple of floats.&quot;</span><span class="p">)</span>

    <span class="c1"># Check that the f_normalize is a boolean</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_normalize</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The f_normalize must be a boolean.&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the magnetic calibration</span>
    <span class="c1"># Initial parameters</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">k1a</span> <span class="o">=</span> <span class="n">gains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k1b</span> <span class="o">=</span> <span class="n">gains</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">gains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">gains</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">gains</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">dt_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">dt</span><span class="p">])</span>

    <span class="c1"># Kalman Model</span>
    <span class="n">Bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Measurement model</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])])</span>
    <span class="c1"># Process noise covariance</span>
    <span class="n">Qc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">k1a</span><span class="p">,</span> <span class="n">k1a</span><span class="p">,</span> <span class="n">k1a</span><span class="p">,</span> <span class="n">k1b</span><span class="p">,</span> <span class="n">k1b</span><span class="p">,</span> <span class="n">k1b</span><span class="p">])</span>
    <span class="c1"># Variance in the measurements</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">k2</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k2</span><span class="p">])</span>

    <span class="c1"># KF</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="n">_kf_transition_matrix</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">F1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">F1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">MM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">PP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">AA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">QQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">KK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">H1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># Initial guesses for the state mean and covariance.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b0</span><span class="p">])</span>
    <span class="n">p01</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># P0 gyro</span>
    <span class="n">p02</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># P0 bias</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">p01</span><span class="p">,</span> <span class="n">p01</span><span class="p">,</span> <span class="n">p01</span><span class="p">,</span> <span class="n">p02</span><span class="p">,</span> <span class="n">p02</span><span class="p">,</span> <span class="n">p02</span><span class="p">])</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P0</span>

    <span class="c1"># Filtering steps.</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Discretization of the continous-time system (dtk)</span>
        <span class="n">dtk</span> <span class="o">=</span> <span class="n">dt_vec</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span>

        <span class="p">[</span><span class="n">Ak</span><span class="p">,</span> <span class="n">Bk</span><span class="p">,</span> <span class="n">Qk</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kf_lti_discretize</span><span class="p">(</span><span class="n">_kf_transition_matrix</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Bc</span><span class="p">,</span> <span class="n">Qc</span><span class="p">,</span> <span class="n">dtk</span><span class="p">)</span>

        <span class="n">AA</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ak</span>
        <span class="n">QQ</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qk</span>

        <span class="c1"># Prediction</span>
        <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kf_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Ak</span><span class="p">,</span> <span class="n">Qk</span><span class="p">)</span>
        <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kf_update</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">mf</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">],</span> <span class="n">H1</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

        <span class="n">MM</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">PP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
        <span class="n">KK</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span>

    <span class="c1"># Final Bias averaging last 20%</span>
    <span class="n">hard_iron</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">MM</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.2</span><span class="p">)):],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calibrate magnetic field</span>
    <span class="n">calibrated_magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span> <span class="o">-</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">calibrated_filteres_magnetic_field</span> <span class="o">=</span> <span class="n">MM</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">calibrated_magnetic_field</span><span class="p">,</span> <span class="n">calibrated_filteres_magnetic_field</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">




    <div class="doc doc-contents first">

        <p>The adaptive identification for sensor bias calibration proposes that the
unknown sensor bias, <span class="arithmatex">\(b\)</span>, can be estimated on-line with a novel adaptive
identification algorithm. The possible advantages of this adaptive approach
are that (i) it does not require numerical differentiation of the sensor
measurement <span class="arithmatex">\(x(t)\)</span>, (ii) it is less computationally expensive than the SAR-KF,
and (iii) it could be combined with other nonlinear observer methods.</p>
<p>For further information refer to section IV.C in Troni, G. and Whitcomb, L. L.
(2019). Field sensor bias calibration with angular-rate sensors: Theory and
experimental evaluation with application to magnetometer calibration. IEEE/ASME
Transactions on Mechatronics, 24(4):1698--1710.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>magnetic_field</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Magnetic field measurements in a
3xN or Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>angular_rate</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Angular rate measurements in a 3xN or
Nx3 numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>time</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time measurements in a 1D numpy array or list.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>gains</code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gains defined in the set of equations (5) of the proposed method as
a tuple of floats, by default (1.0, 1.0)</p>
              </div>
            </td>
            <td>
                  <code>(1.0, 1.0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>f_normalize</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the k2 gain should be scaled by and adaptive
constant computed as the reciprocal of the norm of the gyroscope measurement
for that step, by default False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hard_iron</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hard iron bias.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated magnetic field measurements</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>calibrated_filtered_magnetic_field</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Calibrated and filtered magnetic field measurements</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not numpy arrays or lists.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the magnetic field, angular rate, and time do not have the same number of samples.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the gains are not a tuple of floats.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>TypeError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the f_normalize is not a boolean.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>magyc/benchmark_methods/sar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sar_aid</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">angular_rate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
            <span class="n">time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">gains</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">f_normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The adaptive identification for sensor bias calibration proposes that the</span>
<span class="sd">    unknown sensor bias, $b$, can be estimated on-line with a novel adaptive</span>
<span class="sd">    identification algorithm. The possible advantages of this adaptive approach</span>
<span class="sd">    are that (i) it does not require numerical differentiation of the sensor</span>
<span class="sd">    measurement $x(t)$, (ii) it is less computationally expensive than the SAR-KF,</span>
<span class="sd">    and (iii) it could be combined with other nonlinear observer methods.</span>

<span class="sd">    For further information refer to section IV.C in Troni, G. and Whitcomb, L. L.</span>
<span class="sd">    (2019). Field sensor bias calibration with angular-rate sensors: Theory and</span>
<span class="sd">    experimental evaluation with application to magnetometer calibration. IEEE/ASME</span>
<span class="sd">    Transactions on Mechatronics, 24(4):1698--1710.</span>

<span class="sd">    Args:</span>
<span class="sd">        magnetic_field (numpy.ndarray or list): Magnetic field measurements in a</span>
<span class="sd">            3xN or Nx3 numpy array or list.</span>
<span class="sd">        angular_rate (numpy.ndarray or list): Angular rate measurements in a 3xN or</span>
<span class="sd">            Nx3 numpy array or list.</span>
<span class="sd">        time (numpy.ndarray or list): Time measurements in a 1D numpy array or list.</span>
<span class="sd">        gains (tuple): Gains defined in the set of equations (5) of the proposed method as</span>
<span class="sd">            a tuple of floats, by default (1.0, 1.0)</span>
<span class="sd">        f_normalize (bool): Whether the k2 gain should be scaled by and adaptive</span>
<span class="sd">            constant computed as the reciprocal of the norm of the gyroscope measurement</span>
<span class="sd">            for that step, by default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        hard_iron (numpy.ndarray): Hard iron bias.</span>
<span class="sd">        calibrated_magnetic_field (numpy.ndarray): Calibrated magnetic field measurements</span>
<span class="sd">        calibrated_filtered_magnetic_field (numpy.ndarray): Calibrated and filtered magnetic field measurements</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the magnetic field, angular rate, or time are not numpy arrays or lists.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, or time are not 3xN or Nx3 numpy arrays.</span>
<span class="sd">        ValueError: If the magnetic field, angular rate, and time do not have the same number of samples.</span>
<span class="sd">        TypeError: If the gains are not a tuple of floats.</span>
<span class="sd">        TypeError: If the f_normalize is not a boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the magnetic_field, angular_rate, and time are lists and convert them to numpy arrays</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time are numpy arrays</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">magnetic_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angular_rate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a numpy array or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The time must be a numpy array or a list.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the magnetic_field and angular_rate are 3xN or Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The angular rate must be a 3xN or Nx3 numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the time is a 1D numpy array</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The time must be a (n, ), (n, 1) or (1, n) numpy array.&quot;</span><span class="p">)</span>

    <span class="c1"># Force the magnetic_field and angular_rate to be Nx3 numpy arrays</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">angular_rate</span> <span class="o">=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Check if the magnetic_field, angular_rate, and time have the same number of samples</span>
    <span class="k">if</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The magnetic field, angular rate, and time must have the same number of samples.&quot;</span><span class="p">)</span>

    <span class="c1"># Check that the gains are a tuple of floats</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gains</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The gains must be a tuple of floats.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">gain</span> <span class="ow">in</span> <span class="n">gains</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The gains must be a tuple of floats.&quot;</span><span class="p">)</span>

    <span class="c1"># Check that the f_normalize is a boolean</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_normalize</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The f_normalize must be a boolean.&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the magnetic calibration</span>
    <span class="c1"># Initial parameters</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">gains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">gains</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">angular_rate</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">dt_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">dt</span><span class="p">])</span>

    <span class="c1"># Compute the skew-symmetric matrix of the angular rate.</span>
    <span class="n">skew_symmetric_angular_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">nm</span><span class="o">.</span><span class="n">vec_to_so3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">angular_rate</span><span class="p">)</span>

    <span class="c1"># Adaptive ID system</span>
    <span class="n">mh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mhd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">bh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">bhd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">mh</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnetic_field</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">bh</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b0</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">mhd</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span> <span class="n">skew_symmetric_angular_rate</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">skew_symmetric_angular_rate</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">bh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">k1</span> <span class="o">*</span> <span class="p">(</span><span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">mf</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f_normalize</span><span class="p">:</span>
            <span class="n">k_adap</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span>
            <span class="n">bhd</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k_adap</span> <span class="o">*</span> <span class="n">k2</span> <span class="o">*</span> <span class="n">skew_symmetric_angular_rate</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">@</span> <span class="p">(</span><span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">mf</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bhd</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k2</span> <span class="o">*</span> <span class="n">skew_symmetric_angular_rate</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">mf</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span>

        <span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_vec</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">*</span> <span class="n">mhd</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span>
        <span class="n">bh</span><span class="p">[:,</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bh</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_vec</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">*</span> <span class="n">bhd</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span>

    <span class="c1"># Final Bias averaging last 20%</span>
    <span class="n">hard_iron</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bh</span><span class="p">[:,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)):],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calibrate magnetic field</span>
    <span class="n">calibrated_magnetic_field</span> <span class="o">=</span> <span class="n">magnetic_field</span> <span class="o">-</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">calibrated_filtered_magnetic_field</span> <span class="o">=</span> <span class="n">mh</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">hard_iron</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">calibrated_magnetic_field</span><span class="p">,</span> <span class="n">calibrated_filtered_magnetic_field</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>